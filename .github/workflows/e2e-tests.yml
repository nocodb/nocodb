name: e2e (testRigor on NocoDB)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install testRigor CLI
        run: npm install -g testrigor-cli

      - name: Start NocoDB (SQLite) on port 8080
        run: |
          mkdir -p "$PWD/nocodb"
          docker run -d --name noco \
            -v "$PWD/nocodb:/usr/app/data/" \
            -p 8080:8080 \
            --health-cmd="wget -qO- http://127.0.0.1:8080/api/v1/health >/dev/null || exit 1" \
            --health-interval=10s \
            --health-retries=60 \
            nocodb/nocodb:latest

      - name: Wait for NocoDB API health
        run: |
          echo "Waiting for http://localhost:8080/api/v1/health ..."
          for i in {1..120}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/v1/health || true)
            if [ "$code" = "200" ]; then
              echo "NocoDB is healthy (HTTP 200)"; exit 0
            fi
            sleep 2
          done
          echo "NocoDB failed to become healthy"
          docker ps -a
          docker logs noco || true
          exit 1

      - name: Run testRigor suite (tunneled to localhost)
        env:
          TESTRIGOR_SUITE_ID: ${{ vars.TESTRIGOR_SUITE_ID }}       
          TESTRIGOR_CICD_TOKEN: ${{ secrets.TESTRIGOR_CICD_TOKEN }} 
        run: |
          testrigor test-suite run "$TESTRIGOR_SUITE_ID" \
            --token "$TESTRIGOR_CICD_TOKEN" \
            --url http://localhost:8080 \
            --localhost \
            --junit-report-save-path ./testrigor-report.xml \
            --verbose

      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testrigor-junit
          path: testrigor-report.xml

      - name: Dump NocoDB logs (on failure)
        if: failure()
        run: docker logs noco || true

      - name: Cleanup
        if: always()
        run: docker rm -f noco || true
