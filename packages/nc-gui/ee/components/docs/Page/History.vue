<script lang="ts" setup>
import InfiniteLoading from 'v3-infinite-loading'
import type { DocsPageSnapshotType } from 'nocodb-sdk'

import dayjs from 'dayjs'
import utc from 'dayjs/plugin/utc'

const emit = defineEmits(['close'])

dayjs.extend(utc)

const { $api } = useNuxtApp()
const { base } = storeToRefs(useBase())
const { openedPage } = storeToRefs(useDocStore())
const { history, currentSnapshot } = storeToRefs(useDocHistoryStore())
const { setCurrentSnapshotIndex, setHistory } = useDocHistoryStore()

const close = () => {
  setCurrentSnapshotIndex(undefined)
  emit('close')
}

const pageNumber = ref(0)

onMounted(async () => {
  await $api.nocoDocs.syncPageHistory(base.value!.id!, openedPage.value!.id!)
  const response = await $api.nocoDocs.listPageHistory(base.value!.id!, openedPage.value!.id!, {
    pageNumber: 0,
    pageSize: 10,
  })

  setHistory(response.snapshots!)
})

const clearCurrentSnapshot = () => {
  setCurrentSnapshotIndex(undefined)
}

const loadListData = async ($state: any) => {
  $state.loading()
  pageNumber.value += 1
  const response = await $api.nocoDocs.listPageHistory(base.value!.id!, openedPage.value!.id!, {
    pageNumber: pageNumber.value,
    pageSize: 10,
  })

  if (response.snapshots?.length === 0) {
    $state.complete()
    return
  }

  setHistory([...history.value, ...response.snapshots!])
  $state.loaded()
}

const snapshotTypeLabel = (snapshot: DocsPageSnapshotType) => {
  if (snapshot.type === 'updated') {
    return 'Edited'
  } else if (snapshot.type === 'published') {
    return 'Published'
  } else if (snapshot.type === 'unpublished') {
    return 'Unpublished'
  } else if (snapshot.type === 'restored') {
    return 'Restored'
  } else if (snapshot.type === 'created') {
    return 'Created'
  }
}
</script>

<template>
  <div
    class="history-pane flex flex-col w-1/4 max-w-80 px-5 shadow-sm border-l-1 border-gray-100"
    data-testid="nc-doc-page-history-pane"
  >
    <div class="flex flex-row justify-between font-semibold text-base my-3 px-1.5 w-full items-center select-none">
      <div>History</div>
      <div class="p-1 flex items-center hover:bg-gray-100 cursor-pointer rounded-md" @click="close">
        <MdiArrowLeft />
      </div>
    </div>

    <div class="flex flex-col" data-testid="nc-doc-page-history-pane-list">
      <div
        class="nc-doc-page-history-pane-list-item flex flex-row py-3 px-3 my-1.5 rounded-md hover:bg-gray-100 cursor-pointer border-1 border-gray-100 select-none"
        :class="{
          'bg-gray-100': !currentSnapshot,
        }"
        :aria-selected="!currentSnapshot"
        @click="clearCurrentSnapshot"
      >
        <div>Current version</div>
      </div>
      <div
        v-for="(item, index) in history"
        :key="item.id"
        class="nc-doc-page-history-pane-list-item flex flex-row py-3 px-3 my-1.5 rounded-md hover:bg-gray-100 cursor-pointer border-1 border-gray-100 select-none"
        :class="{
          'bg-gray-100': currentSnapshot && currentSnapshot.id === item.id,
        }"
        :aria-selected="currentSnapshot && currentSnapshot.id === item.id"
        @click="setCurrentSnapshotIndex(index)"
      >
        <div>{{ snapshotTypeLabel(item) }} {{ dayjs.utc(item.created_at).fromNow() }}</div>
      </div>
      <InfiniteLoading v-bind="$attrs" @infinite="loadListData">
        <template #spinner>
          <div class="flex flex-row w-full justify-center mt-2">
            <a-spin />
          </div>
        </template>
        <template #complete>
          <span></span>
        </template>
      </InfiniteLoading>
    </div>
  </div>
</template>

<style lang="scss" scoped>
.history-pane {
  overflow-y: overlay;
  overflow-x: hidden;
  // scrollbar reduce width and gray color
  &::-webkit-scrollbar {
    width: 6px !important;
  }

  /* Track */
  &::-webkit-scrollbar-track {
    background: #ffffff !important;
  }

  /* Handle */
  &::-webkit-scrollbar-thumb {
    background: #c4c4c4;
  }

  /* Handle on hover */
  &::-webkit-scrollbar-thumb:hover {
    background: #9e9e9e;
  }
}
</style>
