<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import { type TableType } from 'nocodb-sdk'
import PageEditor from './components/PageEditor.vue'
import { type PageDesignerPayload } from './lib/payload'
import { PageOrientation, PageType } from './lib/layout'
import { PageDesignerPayloadInj, PageDesignerRowInj, PageDesignerTableTypeInj } from './lib/context'
import TableAndViewPicker from './components/TableAndViewPicker.vue'

const { extension, fullscreen, getTableMeta } = useExtensionHelperOrThrow()

const KV_STORE_KEY = 'pageDesigner'

const savedPayload = ref<PageDesignerPayload>({
  widgets: {},
  orientation: PageOrientation.PORTRAIT,
  pageType: PageType.LETTER,
  lastWidgetId: 0,
  currentWidgetId: -1,
})

const row = ref<Partial<Row>>({})
const meta = ref<TableType>()
const displayField = computed(() => meta.value?.columns?.find((c) => c?.pv) || meta.value?.columns?.[0] || null)
provide(PageDesignerPayloadInj, savedPayload)
provide(PageDesignerRowInj, row)
provide(PageDesignerTableTypeInj, meta)

async function saveChanges() {
  await extension.value.kvStore.set(KV_STORE_KEY, savedPayload.value)
}

onMounted(async () => {
  const saved = (await extension.value.kvStore.get(KV_STORE_KEY)) as PageDesignerPayload
  if (saved) {
    savedPayload.value = saved
  }
})

watch(
  () => {
    return {
      selectedTableId: savedPayload.value.selectedTableId,
      selectedViewId: savedPayload.value.selectedViewId,
      pageName: savedPayload.value.pageName,
      widgets: savedPayload.value.widgets,
      orientation: savedPayload.value.orientation,
      pageType: savedPayload.value.pageType,
    }
  },
  () => {
    saveChanges()
  },
  { deep: true },
)

watch(
  () => savedPayload.value.selectedTableId,
  async (tableId) => {
    if (!tableId) return
    row.value = {}
    const tableMeta = await getTableMeta(tableId)
    if (tableMeta) meta.value = tableMeta
  },
  {
    immediate: true,
  },
)
</script>

<template>
  <ExtensionsExtensionWrapper class="page-designer" @header-click="savedPayload.currentWidgetId = -1">
    <template v-if="fullscreen" #headerExtra>
      <!-- <NcButton> Header actions </NcButton> -->
    </template>
    <div class="flex flex-col h-full">
      <div v-if="!fullscreen" class="flex flex-col max-h-full">
        <div class="p-3 flex">
          <TableAndViewPicker />
        </div>
        <div class="px-3 flex">
          <NRecordPicker
            v-if="savedPayload.selectedTableId"
            :key="savedPayload.selectedTableId + savedPayload.selectedViewId"
            v-model:model-value="row"
            :label="row ? row[displayField?.title ?? ''] ?? 'Select Record' : 'Select Record'"
            :table-id="savedPayload.selectedTableId"
            :view-id="savedPayload.selectedViewId"
            class="w-full page-designer-record-picker"
          />
        </div>
        <div class="overflow-y-auto flex-1 relative group mt-3 mini-layout">
          <div
            class="absolute opacity-0 group-hover:opacity-100 transition-opacity duration-200 ease-in-out transform -translate-x-2/4 -translate-y-2/4 left-2/4 top-2/4"
            style="z-index: 10000"
          >
            <NcButton @click="fullscreen = true">
              <template #icon>
                <GeneralIcon icon="ncEdit"></GeneralIcon>
              </template>
              Edit Layout
            </NcButton>
          </div>
          <PageEditor style="zoom: 50%" />
        </div>
      </div>
      <PageEditor v-else />
    </div>
  </ExtensionsExtensionWrapper>
</template>

<style lang="scss">
.page-designer {
  .page-widget {
    & > .absolute {
      border-radius: 2px;
      outline: 2px solid transparent;
      transition: outline 200ms ease-in-out;
    }
    &:hover {
      > .absolute {
        outline: 2px solid gray;
      }
    }
    &.active-page-widget > .absolute {
      outline: 2px solid #3366ff;
    }
  }
  .page-widget:not(.active-page-widget) {
    .moveable-control,
    .moveable-rotation-line {
      @apply invisible;
    }
  }
  .nc-moveable .moveable-line {
    @apply bg-transparent;
  }
  .nc-moveable .moveable-rotation {
    .moveable-rotation-line {
      @apply bg-nc-fill-primary w-[2px] -ml-[0.5px];
    }
    .moveable-rotation-control {
      @apply !border-nc-border-brand;
    }
  }
  .nc-moveable .moveable-control:not(.moveable-rotation-control) {
    @apply rounded-[3px] w-[10px] h-[10px] border-2 border-solid border-nc-border-brand bg-nc-bg-default -mt-[5px] -ml-[5px];
  }

  .page-designer-record-picker {
    > div {
      @apply !justify-start pl-2;
    }
  }

  .radio-pills {
    @apply rounded-lg;
    label.ant-radio-button-wrapper {
      @apply bg-nc-bg-gray-light !border-t-nc-border-gray-light !border-b-nc-border-gray-light !border-l-nc-border-gray-light !border-r-nc-border-gray-medium;
      @apply px-2 text-nc-content-gray-subtle;
      &.ant-radio-button-wrapper-checked {
        @apply !outline-none !shadow-none !text-nc-content-brand-disabled;
      }
      &:before {
        @apply !bg-transparent;
      }
    }
    > :first-child {
      @apply rounded-[8px_0_0_8px] !border-l-0;
    }
    > :last-child {
      @apply rounded-[0_8px_8px_0] !border-r-0;
    }
    .nc-icon {
      @apply -mt-[2px];
    }
  }

  .border-inputs {
    .ant-input {
      @apply !rounded-lg h-8 w-8 text-center;
      padding: 2px;
      -moz-appearance: textfield; /*For FireFox*/

      &::-webkit-inner-spin-button {
        /*For Webkits like Chrome and Safari*/
        -webkit-appearance: none;
        margin: 0;
      }
    }
  }

  .ant-input-affix-wrapper .ant-input {
    @apply !shadow-none;
  }
  .ant-select-selector,
  .ant-input,
  .ant-input-affix-wrapper {
    @apply !rounded-lg !border-nc-border-gray-medium;
    box-shadow: 0px 0px 4px 0px rgba(0, 0, 0, 0.08) !important;
    &:focus,
    &:focus-within {
      @apply !border-nc-border-brand;
      box-shadow: 0px 0px 0px 2px rgba(51, 102, 255, 0.24) !important;
    }
  }
  .properties-panel {
    .ant-select-selection-item {
      @apply !inline-block;
    }
    .widget-header {
      h1 {
        @apply text-xl font-bold leading-8 tracking-[-0.4px] px-6 py-4 border-b border-solid border-nc-border-gray-medium;
      }
    }
  }
}
</style>
