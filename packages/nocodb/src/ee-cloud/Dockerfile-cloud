###########
# Builder
###########
FROM node:22.12.0-alpine as builder
WORKDIR /usr/src/app

# install node-gyp dependencies
RUN apk add --no-cache python3 make g++ py3-setuptools

# install pnpm
RUN corepack enable && corepack prepare pnpm@9.15.4 --activate

# Copy application dependency manifests to the container image.
COPY ./package.json ./package.json
COPY ./docker/nc-gui/ ./docker/nc-gui/
COPY ./docker/main.js ./docker/index.js
COPY ./docker/configure.sh /usr/src/appEntry/configure.sh
# COPY ./docker/start.sh /usr/src/appEntry/start.sh
COPY ./docker/start-cloud.sh /usr/src/appEntry/start.sh
COPY ./src/public/ ./docker/public/

# for pnpm to generate a flat node_modules without symlinks
# so that modclean could work as expected
RUN echo "node-linker=hoisted" > .npmrc

# install production dependencies,
# reduce node_module size with modclean & removing sqlite deps,
# package built code into app.tar.gz & add execute permission to start.sh
RUN pnpm install --prod --shamefully-hoist \
    && pnpm dlx modclean --patterns="default:*" --ignore="nc-lib-gui/**,dayjs/**,express-status-monitor/**,@azure/msal-node/dist/**,@react-email/**,@linear/**" --run  \
    && rm -rf ./node_modules/sqlite3/deps \
    && chmod +x /usr/src/appEntry/start.sh

RUN pnpm uninstall sharp && pnpm install sharp@0.32.6


##########
# Runner
##########
FROM node:22.12.0-alpine
WORKDIR /usr/src/app

ENV NC_DOCKER 0.6
ENV NODE_ENV production
ENV PORT 8080
ENV NC_TOOL_DIR=/usr/app/data/
ENV HOME=/tmp

# Create non-root user
RUN addgroup -g 1001 -S nocodb && \
   adduser -S nocodb -u 1001 -G nocodb

RUN apk --update --no-cache add \
    dumb-init \
    curl \
    jq \
    #required for thumbnail generation
    libreoffice \
    ttf-liberation \
    ttf-dejavu \
    fontconfig && \
    fc-cache -f -v

# Set proper permissions
RUN chown -R nocodb:nocodb /usr/src/app

# Copy packaged production code & main entry file
COPY --from=builder /usr/src/app/ /usr/src/app/
COPY --from=builder /usr/src/appEntry/ /usr/src/appEntry/

# Switch to non-root user
USER nocodb

EXPOSE 8080
ENTRYPOINT ["/usr/bin/dumb-init", "--"]

# Start Nocodb
CMD ["/usr/src/appEntry/start.sh"]
